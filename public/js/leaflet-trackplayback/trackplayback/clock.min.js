L.Clock=L.Class.extend({includes:L.Mixin.Events,options:{speed:1,maxSpeed:65},initialize:function(trackController,options){L.setOptions(this,options),this._trackController=trackController,this._endTime=this._trackController.getMaxTime(),this._curTime=this._trackController.getMinTime(),this._speed=this.options.speed,this._maxSpeed=this.options.maxSpeed,this._intervalID=null,this._lastFpsUpdateTime=0},start:function(){this._intervalID||(this._intervalID=L.Util.requestAnimFrame(this._tick,this))},stop:function(){this._intervalID&&(L.Util.cancelAnimFrame(this._intervalID),this._intervalID=null,this._lastFpsUpdateTime=0)},rePlaying:function(){this.stop(),this._curTime=this._trackController.getMinTime(),this.start()},slowSpeed:function(){this._speed=this._speed<=1?this._speed:this._speed-1,this._intervalID&&(this.stop(),this.start())},quickSpeed:function(){this._speed=this._speed>=this._maxSpeed?this._speed:this._speed+1,this._intervalID&&(this.stop(),this.start())},getSpeed:function(){return this._speed},getCurTime:function(){return this._curTime},getStartTime:function(){return this._trackController.getMinTime()},getEndTime:function(){return this._trackController.getMaxTime()},isPlaying:function(){return!!this._intervalID},setCursor:function(time){this._curTime=time,this._trackController.drawTracksByTime(this._curTime),this.fire("tick",{time:this._curTime})},setSpeed:function(speed){this._speed=speed,this._intervalID&&(this.stop(),this.start())},_caculatefpsTime:function(now){let time;return time=0===this._lastFpsUpdateTime?0:now-this._lastFpsUpdateTime,this._lastFpsUpdateTime=now,time/=1e3,time},_tick:function(){let now=+new Date,fpstime,isPause=!1,stepTime=this._caculatefpsTime(now)*Math.pow(2,this._speed-1);this._curTime+=stepTime,this._curTime>=this._endTime&&(this._curTime=this._endTime,isPause=!0),this._trackController.drawTracksByTime(this._curTime),this.fire("tick",{time:this._curTime}),isPause||(this._intervalID=L.Util.requestAnimFrame(this._tick,this))}}),L.clock=function(trackController,options){return new L.Clock(trackController,options)};