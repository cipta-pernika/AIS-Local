L.DrawPlayback=L.Class.extend({trackPointOptions:{isDraw:!1,useCanvas:!0,stroke:!1,color:"#ef0300",fill:!0,fillColor:"#ef0300",opacity:.3,radius:4},trackLineOptions:{isDraw:!1,stroke:!0,color:"#1C54E2",weight:2,fill:!1,fillColor:"#000",opacity:.3},targetOptions:{useImg:!1,imgUrl:"../../static/images/ship.png",showText:!1,width:8,height:18,color:"#00f",fillColor:"#9FD12D"},toolTipOptions:{offset:[0,0],direction:"top",permanent:!1},initialize:function(map,options){if(L.extend(this.trackPointOptions,options.trackPointOptions),L.extend(this.trackLineOptions,options.trackLineOptions),L.extend(this.targetOptions,options.targetOptions),L.extend(this.toolTipOptions,options.toolTipOptions),this._showTrackPoint=this.trackPointOptions.isDraw,this._showTrackLine=this.trackLineOptions.isDraw,this._map=map,this._map.on("mousemove",this._onmousemoveEvt,this),this._trackLayer=(new L.TrackLayer).addTo(map),this._trackLayer.on("update",this._trackLayerUpdate,this),this._canvas=this._trackLayer.getContainer(),this._ctx=this._canvas.getContext("2d"),this._bufferTracks=[],this.trackPointOptions.useCanvas||(this._trackPointFeatureGroup=L.featureGroup([]).addTo(map)),this.targetOptions.useImg){const img=new Image;img.onload=()=>{this._targetImg=img},img.onerror=()=>{throw new Error("img load error!")},img.src=this.targetOptions.imgUrl}},update:function(){this._trackLayerUpdate()},drawTrack:function(trackpoints){this._bufferTracks.push(trackpoints),this._drawTrack(trackpoints)},showTrackPoint:function(){this._showTrackPoint=!0,this.update()},hideTrackPoint:function(){this._showTrackPoint=!1,this.update()},showTrackLine:function(){this._showTrackLine=!0,this.update()},hideTrackLine:function(){this._showTrackLine=!1,this.update()},remove:function(){this._bufferTracks=[],this._trackLayer.off("update",this._trackLayerUpdate,this),this._map.off("mousemove",this._onmousemoveEvt,this),this._map.hasLayer(this._trackLayer)&&this._map.removeLayer(this._trackLayer),this._map.hasLayer(this._trackPointFeatureGroup)&&this._map.removeLayer(this._trackPointFeatureGroup)},clear:function(){this._clearLayer(),this._bufferTracks=[]},_trackLayerUpdate:function(){this._bufferTracks.length&&(this._clearLayer(),this._bufferTracks.forEach(function(element,index){this._drawTrack(element)}.bind(this)))},_onmousemoveEvt:function(e){if(!this._showTrackPoint)return;let point=e.layerPoint;if(this._bufferTracks.length)for(let i=0,leni=this._bufferTracks.length;i<leni;i++)for(let j=0,len=this._bufferTracks[i].length;j<len;j++){let tpoint=this._getLayerPoint(this._bufferTracks[i][j]);if(point.distanceTo(tpoint)<=this.trackPointOptions.radius)return void this._opentoolTip(this._bufferTracks[i][j])}this._map.hasLayer(this._tooltip)&&this._map.removeLayer(this._tooltip),this._canvas.style.cursor="pointer"},_opentoolTip:function(trackpoint){this._map.hasLayer(this._tooltip)&&this._map.removeLayer(this._tooltip),this._canvas.style.cursor="default";let latlng=L.latLng(trackpoint.lat,trackpoint.lng),tooltip=this._tooltip=L.tooltip(this.toolTipOptions);tooltip.setLatLng(latlng),tooltip.addTo(this._map),tooltip.setContent(this._getTooltipText(trackpoint))},_drawTrack:function(trackpoints){this._showTrackLine&&this._drawTrackLine(trackpoints);let targetPoint=trackpoints[trackpoints.length-1];this.targetOptions.useImg&&this._targetImg?this._drawShipImage(targetPoint):this._drawShipCanvas(targetPoint),this.targetOptions.showText&&this._drawtxt(`航向：${parseInt(targetPoint.dir)}度`,targetPoint),this._showTrackPoint&&(this.trackPointOptions.useCanvas?this._drawTrackPointsCanvas(trackpoints):this._drawTrackPointsSvg(trackpoints))},_drawTrackLine:function(trackpoints){let options=this.trackLineOptions,tp0=this._getLayerPoint(trackpoints[0]);this._ctx.save(),this._ctx.beginPath(),this._ctx.moveTo(tp0.x,tp0.y);for(let i=1,len=trackpoints.length;i<len;i++){let tpi=this._getLayerPoint(trackpoints[i]);this._ctx.lineTo(tpi.x,tpi.y)}this._ctx.globalAlpha=options.opacity,options.stroke&&(this._ctx.strokeStyle=options.color,this._ctx.lineWidth=options.weight,this._ctx.stroke()),options.fill&&(this._ctx.fillStyle=options.fillColor,this._ctx.fill()),this._ctx.restore()},_drawTrackPointsCanvas:function(trackpoints){let options=this.trackPointOptions;this._ctx.save();for(let i=0,len=trackpoints.length;i<len;i++)if(trackpoints[i].isOrigin){let latLng=L.latLng(trackpoints[i].lat,trackpoints[i].lng),radius=options.radius,point=this._map.latLngToLayerPoint(latLng);this._ctx.beginPath(),this._ctx.arc(point.x,point.y,radius,0,2*Math.PI,!1),this._ctx.globalAlpha=options.opacity,options.stroke&&(this._ctx.strokeStyle=options.color,this._ctx.stroke()),options.fill&&(this._ctx.fillStyle=options.fillColor,this._ctx.fill())}this._ctx.restore()},_drawTrackPointsSvg:function(trackpoints){for(let i=0,len=trackpoints.length;i<len;i++)if(trackpoints[i].isOrigin){let latLng=L.latLng(trackpoints[i].lat,trackpoints[i].lng),cricleMarker=L.circleMarker(latLng,this.trackPointOptions);cricleMarker.bindTooltip(this._getTooltipText(trackpoints[i]),this.toolTipOptions),this._trackPointFeatureGroup.addLayer(cricleMarker)}},_drawtxt:function(text,trackpoint){let point=this._getLayerPoint(trackpoint);this._ctx.save(),this._ctx.font="12px Verdana",this._ctx.fillStyle="#000",this._ctx.textAlign="center",this._ctx.textBaseline="bottom",this._ctx.fillText(text,point.x,point.y-12,200),this._ctx.restore()},_drawShipCanvas:function(trackpoint){let point=this._getLayerPoint(trackpoint),rotate=trackpoint.dir||0,w=this.targetOptions.width,h=this.targetOptions.height,dh=h/3;this._ctx.save(),this._ctx.fillStyle=this.targetOptions.fillColor,this._ctx.strokeStyle=this.targetOptions.color,this._ctx.translate(point.x,point.y),this._ctx.rotate(Math.PI/180*rotate),this._ctx.beginPath(),this._ctx.moveTo(0,0-h/2),this._ctx.lineTo(0-w/2,0-h/2+dh),this._ctx.lineTo(0-w/2,0+h/2),this._ctx.lineTo(0+w/2,0+h/2),this._ctx.lineTo(0+w/2,0-h/2+dh),this._ctx.closePath(),this._ctx.fill(),this._ctx.stroke(),this._ctx.restore()},_drawShipImage:function(trackpoint){let point=this._getLayerPoint(trackpoint),dir=trackpoint.dir||0,width=this.targetOptions.width,height=this.targetOptions.height,offset_x=width/2,offset_y=height/2;this._ctx.save(),this._ctx.translate(point.x,point.y),this._ctx.rotate(Math.PI/180*dir),this._ctx.drawImage(this._targetImg,0-offset_x,0-offset_y,width,height),this._ctx.restore()},_getTooltipText:function(targetobj){let content=[];if(content.push("<table>"),targetobj.info&&targetobj.info.length)for(let i=0,len=targetobj.info.length;i<len;i++)content.push("<tr>"),content.push("<td>"+targetobj.info[i].key+"</td>"),content.push("<td>"+targetobj.info[i].value+"</td>"),content.push("</tr>");return content.push("</table>"),content=content.join(""),content},_clearLayer:function(){let bounds=this._trackLayer.getBounds();if(bounds){let size=bounds.getSize();this._ctx.clearRect(bounds.min.x,bounds.min.y,size.x,size.y)}else this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height);this._map.hasLayer(this._trackPointFeatureGroup)&&this._trackPointFeatureGroup.clearLayers()},_getLayerPoint(trackpoint){return this._map.latLngToLayerPoint(L.latLng(trackpoint.lat,trackpoint.lng))}}),L.drawplayback=function(map,options){return new L.DrawPlayback(map,options)};